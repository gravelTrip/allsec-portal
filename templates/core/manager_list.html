{% extends "base.html" %}
{% block title %}Zarządcy – ALLSEC Portal{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-0">Zarządcy</h1>
    <p class="text-muted small mb-0">
      Lista zarządców/administratorów obsługiwanych obiektów.
    </p>
  </div>

  {% if can_create %}
    <a href="{% url 'core:manager_create' %}" class="btn btn-success btn-sm">
      + Nowy zarządca
    </a>
  {% endif %}
</div>

<div class="card shadow-sm border-0">

  <div class="card-header bg-white">
    <form method="get" id="manager-filters-form" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label form-label-sm mb-1">Nazwa</label>
        <input type="search"
               name="name"
               value="{{ filters.name }}"
               class="form-control form-control-sm manager-filter-text"
               placeholder="Nazwa skrócona / pełna…">
      </div>

      <div class="col-md-3">
        <label class="form-label form-label-sm mb-1">NIP</label>
        <input type="search"
               name="nip"
               value="{{ filters.nip }}"
               class="form-control form-control-sm manager-filter-text"
               placeholder="np. 123…">
      </div>

      <div class="col-md-3">
        <label class="form-label form-label-sm mb-1">Adres</label>
        <input type="search"
               name="street"
               value="{{ filters.street }}"
               class="form-control form-control-sm manager-filter-text"
               placeholder="Ulica i numer…">
      </div>

      <div class="col-md-3">
        <label class="form-label form-label-sm mb-1">Miasto</label>
        <select name="city" id="manager-filter-city" class="form-select form-select-sm">
          <option value="">Wszystkie</option>
          {% for c in city_choices %}
            <option value="{{ c }}" {% if c == filters.city %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 d-flex justify-content-end mt-1">
        <a href="{% url 'core:manager_list' %}" class="btn btn-sm btn-outline-secondary">Resetuj</a>
      </div>
    </form>
  </div>

  <div class="card-body p-0">
    <table class="table table-sm mb-0 align-middle">
      <thead class="table-light">
        <tr class="small text-muted">
          <th>Nazwa</th>
          <th>Pełna nazwa</th>
          <th>NIP</th>
          <th>Adres</th>
          <th>Miasto</th>
          <th class="text-end"></th>
        </tr>
      </thead>
      <tbody>
        {% if managers %}
          {% for m in managers %}
            <tr>
              <td>
                <a href="{% url 'core:manager_detail' m.pk %}"
                   class="text-reset text-decoration-none fw-semibold"
                   title="{{ m.short_name|default:m.full_name }}">
                  {{ m.short_name|default:m.full_name }}
                </a>
              </td>

              <td title="{{ m.full_name }}">
                {{ m.full_name|default:"—"|truncatechars:40 }}
              </td>

              <td>{{ m.nip|default:"—" }}</td>
              <td>{{ m.street|default:"—" }}</td>
              <td><span class="small text-muted">{{ m.city|default:"—" }}</span></td>

              <td class="text-end">
                {% if can_edit %}
                  <a href="{% url 'core:manager_edit' m.pk %}"
                     class="btn btn-sm btn-primary btn-icon-square"
                     title="Edytuj">
                    <i class="bi bi-pencil"></i>
                  </a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted small py-3">
              Brak zarządców w bazie.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="card-footer bg-white border-0">
      <nav aria-label="Paginacja zarządców">
        <ul class="pagination pagination-sm mb-0 justify-content-end">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% if qs_base %}{{ qs_base }}&{% endif %}page={{ page_obj.previous_page_number }}">«</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">«</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
              <a class="page-link" href="?{% if qs_base %}{{ qs_base }}&{% endif %}page={{ num }}">{{ num }}</a>
            </li>
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% if qs_base %}{{ qs_base }}&{% endif %}page={{ page_obj.next_page_number }}">»</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  {% endif %}
</div>

<script>
(function () {
  const form = document.getElementById("manager-filters-form");
  if (!form) return;

  const submitNow = () => { if (form.requestSubmit) form.requestSubmit(); else form.submit(); };

  // select -> od razu
  form.querySelectorAll("select").forEach(sel => sel.addEventListener("change", submitNow));

  // input -> debounce
  let t = null;
  form.querySelectorAll(".manager-filter-text").forEach(inp => {
    inp.addEventListener("input", (e) => {
      if (e.isComposing) return;
      clearTimeout(t);
      if (inp.value.length && inp.value.length < 2) return;
      t = setTimeout(submitNow, 800);
    });
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); clearTimeout(t); submitNow(); }
    });
  });

  // TomSelect dla miasta (spójnie z Kontaktami)
  function initCityTomSelect() {
    const citySel = document.getElementById("manager-filter-city");
    if (!citySel) return;

    if (!window.TomSelect) { setTimeout(initCityTomSelect, 50); return; }
    if (citySel.tomselect) return;

    new TomSelect(citySel, {
      allowEmptyOption: true,
      placeholder: "",
      plugins: ["clear_button", "dropdown_input"],
      create: false,
      openOnFocus: true
    });
  }

  document.addEventListener("DOMContentLoaded", initCityTomSelect);
})();
</script>

{% endblock %}
