{% extends "base.html" %}

{% block title %}Dashboard – ALLSEC Portal{% endblock %}

{% block content %}
<div id="dashboard-root" data-user-id="{{ request.user.id }}">

  <!-- NAGŁÓWEK -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">Dashboard</h1>
      <p class="text-muted small mb-0">
        Szybki podgląd zleceń, konserwacji i montaży.
      </p>
    </div>
  </div>

  <!-- KAFLE KPI -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h6 class="card-title text-muted text-uppercase small mb-2">
            Otwarte zlecenia
          </h6>
          <div class="d-flex align-items-baseline">
            <span class="h3 mb-0 me-2">{{ stats.open_orders }}</span>
            <span class="text-muted small">zleceń niezamkniętych</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h6 class="card-title text-muted text-uppercase small mb-2">
            Czeka na decyzję / materiał
          </h6>
          <div class="d-flex align-items-baseline">
            <span class="h3 mb-0 me-2 text-warning">{{ stats.critical_orders }}</span>
            <span class="text-muted small">zleceń oczekujących</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h6 class="card-title text-muted text-uppercase small mb-2">
            Konserwacje po terminie
          </h6>
          <div class="d-flex align-items-baseline">
            <span class="h3 mb-0 me-2 text-danger">{{ stats.overdue_maintenance }}</span>
            <span class="text-muted small">po terminie</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h6 class="card-title text-muted text-uppercase small mb-2">
            Montaże w realizacji
          </h6>
          <div class="d-flex align-items-baseline">
            <span class="h3 mb-0 me-2">{{ stats.jobs_in_progress }}</span>
            <span class="text-muted small">otwarte projekty</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GŁÓWNY RZĄD: ZLECENIA + KONSERWACJE -->
  <div class="row">
    <!-- LEWA KOLUMNA: ZLECENIA -->
    <div class="col-md-9 col-lg-9 mb-3">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Zlecenia</h5>
          </div>

          <form method="get" id="dashboard-orders-filters" class="row g-2 align-items-end">
            <!-- Typ -->
            <div class="col-md-2">
              <label class="form-label form-label-sm mb-1">Typ</label>
              <select name="type" class="form-select form-select-sm">
                <option value="">Wszystkie</option>
                {% for t in order_filters.type_choices %}
                <option value="{{ t.value }}" {% if t.selected %} selected{% endif %}>
                  {{ t.label }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Serwisant -->
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-1">Serwisant</label>
              <select name="assignee" class="form-select form-select-sm">
                <option value="">Wszyscy</option>
                {% for u in order_filters.assignee_choices %}
                <option value="{{ u.id }}" {% if u.selected %} selected{% endif %}>
                  {{ u.label }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Status -->
            <div class="col-md-2">
              <label class="form-label form-label-sm mb-1">Status</label>
              <select name="status" class="form-select form-select-sm">
                <option value="">Wszystkie</option>
                {% for s in order_filters.status_choices %}
                <option value="{{ s.value }}" {% if s.selected %} selected{% endif %}>
                  {{ s.label }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Czas -->
            <div class="col-md-2">
              <label class="form-label form-label-sm mb-1">Czas</label>
              <select name="time" class="form-select form-select-sm" id="dashboard-filter-time">
                {% for t in order_filters.time_choices %}
                <option value="{{ t.value }}" {% if t.selected %} selected{% endif %}>
                  {{ t.label }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Zakres dat -->
            <div class="col-md-3">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label form-label-sm mb-1">Od</label>
                  <input type="date" name="date_from" class="form-control form-control-sm"
                    value="{{ order_filters.date_from }}">
                </div>
                <div class="col-6">
                  <label class="form-label form-label-sm mb-1">Do</label>
                  <input type="date" name="date_to" class="form-control form-control-sm"
                    value="{{ order_filters.date_to }}">
                </div>
              </div>
            </div>

            <!-- Checkbox + przycisk -->
            <div class="col-12 mt-2 d-flex justify-content-between align-items-center">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="hide_completed" value="1"
                  id="hideCompletedCheckbox" {% if order_filters.hide_completed %}checked{% endif %}>
                <label class="form-check-label small" for="hideCompletedCheckbox">
                  Ukryj zakończone
                </label>
              </div>
              <div>
                <div>
                  <button type="button" id="dashboard-filters-reset" class="btn btn-sm btn-outline-secondary">
                    Resetuj
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="card-body p-0">
          <table class="table table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Zlecenie</th>
                <th>Obiekt</th>
                <th>Typ</th>
                <th>Status</th>
                <th>Planowana data</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="dashboard-orders-body">
              {% if today_orders %}
              {% for order in today_orders %}
              <tr data-id="{{ order.id }}">

                <td>
                  {% if order.number %}
                  {{ order.number }}
                  {% else %}
                  #{{ order.id }}
                  {% endif %}
                  {% if order.title %}
                  – {{ order.title }}
                  {% endif %}
                </td>

                <td>
                  {{ order.site.name }}
                </td>
                <td>
                  {% if order.work_type == order.WorkOrderType.SERVICE %}
                  <span class="badge bg-danger">Serwis</span>
                  {% elif order.work_type == order.WorkOrderType.MAINTENANCE %}
                  <span class="badge bg-info text-dark">Konserwacja</span>
                  {% elif order.work_type == order.WorkOrderType.JOB %}
                  <span class="badge bg-secondary">Montaż</span>
                  {% else %}
                  <span class="badge bg-light text-dark">Inne</span>
                  {% endif %}
                </td>
                <td>
  {% if order.status == order.Status.NEW %}
    <span class="badge bg-primary">Do umówienia</span>

  {% elif order.status == order.Status.SCHEDULED %}
    <span class="badge bg-info text-dark">Umówione</span>

  {% elif order.status == order.Status.IN_PROGRESS %}
    <span class="badge bg-warning text-dark">Realizacja</span>

  {% elif order.status == order.Status.REALIZED %}
    <span class="badge bg-primary">Zrealizowane</span>

  {% elif order.status == order.Status.WAITING_FOR_DECISION %}
    <span class="badge bg-secondary">Decyzja</span>

  {% elif order.status == order.Status.WAITING_FOR_PARTS %}
    <span class="badge bg-secondary">Materiał</span>

  {% elif order.status == order.Status.COMPLETED %}
    <span class="badge bg-success">Zakończone</span>

  {% elif order.status == order.Status.CANCELLED %}
    <span class="badge bg-danger">Odwołane</span>

  {% else %}
    <span class="badge bg-light text-dark">Inny</span>
  {% endif %}
</td>

                <td>
                  {{ order.planned_date|date:"d.m.Y" }}
                </td>
                <td class="text-end">
                  <a href="{% url 'core:workorder_detail' pk=order.pk %}" class="btn btn-sm btn-primary">
                    Otwórz
                  </a>
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="7" class="text-muted small text-center py-3">
                  Brak zleceń dla wybranych filtrów.
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PRAWA KOLUMNA: KONSERWACJE NA -->
    <div class="col-md-3 col-lg-3">
      <div class="card shadow-sm border-0 mb-3" id="dashboard-maintenance-card"
        data-year="{{ maintenance_module.selected_year }}" data-month="{{ maintenance_module.selected_month }}">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            Konserwacje na:
          </h6>
          <form method="get" class="mb-0">
            {# Zachowaj aktualne filtry zleceń przy zmianie miesiąca #}
            <input type="hidden" name="type" value="{{ order_filters.type }}">
            <input type="hidden" name="assignee" value="{{ order_filters.assignee }}">
            <input type="hidden" name="status" value="{{ order_filters.status }}">
            <input type="hidden" name="time" value="{{ order_filters.time }}">
            <input type="hidden" name="date_from" value="{{ order_filters.date_from }}">
            <input type="hidden" name="date_to" value="{{ order_filters.date_to }}">
            {% if order_filters.hide_completed %}
            <input type="hidden" name="hide_completed" value="1">
            {% endif %}

            <select name="km" class="form-select form-select-sm" onchange="this.form.submit()">
              {% for m in maintenance_module.month_choices %}
              <option value="{{ m.value }}" {% if m.is_current %} selected{% endif %}>
                {{ m.label }}
              </option>
              {% endfor %}
            </select>
          </form>
        </div>

        <ul class="list-group list-group-flush" id="dashboard-maintenance-list">
          {% if maintenance_module.items %}
          {% for item in maintenance_module.items %}
          <li class="list-group-item d-flex justify-content-between align-items-center small"
            data-id="{{ item.site.id }}">
            <span>{{ item.site.name }}</span>

            {% if item.ongoing_order %}
            <a href="{% url 'core:workorder_detail' pk=item.ongoing_order.pk %}" class="btn btn-sm btn-success">
              W trakcie
            </a>
            {% else %}
            <a href="{% url 'core:workorder_create' %}?site={{ item.site.id }}&work_type=MAINTENANCE&period={{ maintenance_module.selected_period_param }}"
              class="btn btn-sm btn-outline-primary">
              Utwórz
            </a>
            {% endif %}
          </li>
          {% endfor %}
          {% else %}
          <li class="list-group-item small text-muted">
            Brak obiektów do konserwacji w tym miesiącu bez zakończonych zleceń.
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

</div>
{% endblock %}