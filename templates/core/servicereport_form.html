{% extends "base.html" %}

{% block title %}
  {% if report.number %}
    Protokół {{ report.number }} – {{ order.site.name }}
  {% else %}
    Protokół serwisowy – szkic – {{ order.site.name }}
  {% endif %}
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h1 class="h4 mb-1">
      Protokół serwisowy
      {% if report.number %}
        <span class="text-muted">({{ report.number }})</span>
      {% else %}
        <span class="badge bg-secondary ms-2">Szkic – brak numeru</span>
      {% endif %}
    </h1>

    <p class="mb-1 small">
      Status protokołu:
      {% if report.status == report.Status.FINAL %}
        <span class="badge bg-success">Zatwierdzony</span>
      {% else %}
        <span class="badge bg-secondary">Szkic</span>
      {% endif %}
    </p>

    <p class="mb-1 small">
      Zlecenie:
      {% if order.number %}
        {{ order.number }}
      {% else %}
        #{{ order.id }}
      {% endif %}
      – {{ order.title }}
    </p>

    <p class="text-muted small mb-0">
      Obiekt: {{ order.site.name }}
      {% if order.site.city %}
        ({{ order.site.city }})
      {% endif %}
    </p>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'core:workorder_detail' order.pk %}"
       class="btn btn-sm btn-outline-secondary">
      ← Zlecenie
    </a>
  </div>
</div>

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger py-2 small">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <div class="row g-3">
          <!-- LEWA KOLUMNA -->
          <div class="col-lg-6">
            <h6 class="text-uppercase text-muted small mb-2">Dane protokołu</h6>

            <div class="mb-2">
              <label class="form-label small">Data protokołu</label>
              {{ form.report_date }}
            </div>

            <div class="mb-2">
              <label class="form-label small">Tryb serwisu</label>
              {{ form.service_mode }}
            </div>

            <div class="mb-2">
              <label class="form-label small">Forma płatności</label>
              {{ form.payment_method }}
            </div>

            <hr>

            <h6 class="text-uppercase text-muted small mb-2">Zgłaszający</h6>

            <div class="mb-2">
              <label class="form-label small">Osoba zgłaszająca</label>
              {{ form.requester_name }}
            </div>

            <div class="mb-2">
              <label class="form-label small">Telefon</label>
              {{ form.requester_phone }}
            </div>

            <hr>

            <h6 class="text-uppercase text-muted small mb-2">Serwisanci</h6>

            <div class="mb-2">
              <label class="form-label small">Serwisanci</label>
              {{ form.technicians }}
              <div class="form-text small">
                Na razie wpis ręczny, docelowo auto z przypisanego użytkownika.
              </div>
            </div>
          </div>

          <!-- PRAWA KOLUMNA -->
          <div class="col-lg-6">
            <h6 class="text-uppercase text-muted small mb-2">Opis usterki i prac</h6>

            <div class="mb-2">
              <label class="form-label small">Opis usterki / stan przed</label>
              {{ form.description_before }}
            </div>

            <div class="mb-2">
              <label class="form-label small">Opis wykonanych prac</label>
              {{ form.work_performed }}
            </div>

            <div class="mb-2">
              <label class="form-label small">Wynik</label>
              {{ form.result }}
            </div>

            <div class="mb-2">
              <label class="form-label small">Zalecenia / dalsze kroki</label>
              {{ form.next_actions }}
            </div>

            <hr>

            <h6 class="text-uppercase text-muted small mb-2">Notatki wewnętrzne</h6>

            <div class="mb-2">
              {{ form.notes_internal }}
              <div class="form-text small">
                Widoczne tylko wewnętrznie – nie drukują się na protokole dla klienta.
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3 d-flex justify-content-end gap-2">
          <a href="{% url 'core:workorder_detail' order.pk %}"
             class="btn btn-sm btn-outline-secondary">
            Anuluj
          </a>

          {% if report.status != report.Status.FINAL %}
            <button type="submit"
                    name="finalize"
                    value="1"
                    class="btn btn-sm btn-success">
              Zatwierdź i nadaj numer
            </button>
          {% endif %}

          <button type="submit" class="btn btn-sm btn-primary">
            Zapisz protokół
          </button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
