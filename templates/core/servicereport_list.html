{% extends "base.html" %}

{% block title %}Protoko&#322;y serwisowe &#8211; ALLSEC Portal{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0">Protoko&#322;y serwisowe</h1>
      <p class="text-muted small mb-0">
        Lista protoko&#322;&#243;w powi&#261;zanych ze zleceniami serwisowymi.
      </p>
    </div>

    <div class="d-flex align-items-center gap-2">
      <form method="get" class="d-flex align-items-center gap-2 mb-0">
        <div class="form-check form-check-inline ms-2 mb-0" style="white-space: nowrap;">
          <input
            class="form-check-input"
            type="checkbox"
            id="only_final"
            name="only_final"
            {% if only_final %}checked{% endif %}
          >
          <label class="form-check-label small" for="only_final">
            Tylko zatwierdzone
          </label>
        </div>

        <select name="status" class="form-select form-select-sm" style="min-width: 180px;">
          <option value="">Status: wszystkie</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if filter_status == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>

        <button class="btn btn-sm btn-outline-secondary" type="submit">
          Filtruj
        </button>

        {% if filter_status or only_final %}
          <a href="{% url 'core:service_report_list' %}" class="btn btn-sm btn-link">
            Wyczy&#347;&#263;
          </a>
        {% endif %}
      </form>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Numer</th>
            <th>Data protoko&#322;u</th>
            <th>Zlecenie</th>
            <th>Obiekt</th>
            <th>Status</th>
            <th>Tryb serwisu</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% with reports=page_obj.object_list %}
            {% if reports %}
              {% for report in reports %}
                <tr>
                  <td>
                    {% if report.number %}
                      {{ report.number }}
                    {% else %}
                      PS #{{ report.id }}
                    {% endif %}
                  </td>
                  <td>{{ report.report_date|date:"d.m.Y" }}</td>
                  <td>
                    {% if report.work_order %}
                      {% if report.work_order.number %}
                        <a href="{% url 'core:workorder_detail' report.work_order.pk %}">
                          {{ report.work_order.number }}
                        </a>
                      {% else %}
                        <a href="{% url 'core:workorder_detail' report.work_order.pk %}">
                          Zlecenie #{{ report.work_order.id }}
                        </a>
                      {% endif %}
                    {% else %}
                      &#8212;
                    {% endif %}
                  </td>
                  <td>
                    {% if report.work_order and report.work_order.site %}
                      {{ report.work_order.site.name }}<br>
                      <span class="small text-muted">
                        {{ report.work_order.site.city }}
                      </span>
                    {% else %}
                      &#8212;
                    {% endif %}
                  </td>
                  <td>
                    {% if report.status == 'FINAL' %}
                      <span class="badge bg-success">Zatwierdzony</span>
                    {% elif report.status == 'DRAFT' %}
                      <span class="badge bg-secondary">Szkic</span>
                    {% else %}
                      <span class="badge bg-light text-dark">{{ report.get_status_display }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if report.service_mode %}
                      {{ report.get_service_mode_display }}
                    {% else %}
                      &#8212;
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a href="{% url 'core:service_report_detail' report.pk %}"
                      class="btn btn-sm btn-primary">
                      Szczegóły
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted small py-3">
                  Brak protoko&#322;&#243;w do wy&#347;wietlenia.
                </td>
              </tr>
            {% endif %}
          {% endwith %}
        </tbody>
      </table>
    </div>

    {% if page_obj.has_other_pages %}
      <div class="card-footer bg-white">
        <nav aria-label="Paginacja protoko&#322;&#243;w">
          <ul class="pagination pagination-sm mb-0 justify-content-end">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if only_final %}&only_final=on{% endif %}">&laquo;</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
              </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if num == page_obj.number %}
                <li class="page-item active" aria-current="page">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if only_final %}&only_final=on{% endif %}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if only_final %}&only_final=on{% endif %}">&raquo;</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
{% endblock %}
