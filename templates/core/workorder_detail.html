{% extends "base.html" %}

{% block title %}Zlecenie #{{ order.id }} – ALLSEC Portal{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-1">
      {% if order.number %}
        Zlecenie {{ order.number }} – {{ order.title }}
      {% else %}
        Zlecenie #{{ order.id }} – {{ order.title }}
      {% endif %}
    </h1>
    <p class="mb-1">
      <span class="text-muted small">Utworzone:</span>
      {{ order.created_at|date:"d.m.Y H:i" }}
    </p>
    <p class="text-muted small mb-0">
      Szczegóły zlecenia serwisowego / przeglądu / robót.
    </p>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'core:workorder_list' %}" class="btn btn-sm btn-outline-secondary">
      ← Lista zleceń
    </a>

    {% if can_edit %}
      <a href="{% url 'core:workorder_edit' order.pk %}" class="btn btn-sm btn-primary">
        Edytuj zlecenie
      </a>
    {% endif %}
  </div>
</div>

  <div class="row g-3">
    <!-- LEWA KOLUMNA: podstawowe info -->
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white">
          <h6 class="mb-0">Informacje o zleceniu</h6>
        </div>
        <div class="card-body small">
          <div class="mb-2">
            <span class="text-muted">Typ:</span>
            {% if order.work_type == order.WorkOrderType.SERVICE %}
              <span class="badge bg-danger ms-1">Serwis</span>
            {% elif order.work_type == order.WorkOrderType.MAINTENANCE %}
              <span class="badge bg-info text-dark ms-1">Przegląd</span>
            {% elif order.work_type == order.WorkOrderType.JOB %}
              <span class="badge bg-secondary ms-1">Robota</span>
            {% else %}
              <span class="badge bg-light text-dark ms-1">Inne</span>
            {% endif %}
          </div>

          <div class="mb-2">
            <span class="text-muted small">Status:</span>
            {% if order.status == order.Status.NEW %}
              <span class="badge bg-primary">Nowe</span>

            {% elif order.status == order.Status.SCHEDULED %}
              <span class="badge bg-info text-dark">Umówione</span>

            {% elif order.status == order.Status.IN_PROGRESS %}
              <span class="badge bg-warning text-dark">W realizacji</span>

            {% elif order.status == order.Status.WAITING_FOR_DECISION %}
              <span class="badge bg-secondary">Czeka na decyzję</span>

            {% elif order.status == order.Status.WAITING_FOR_PARTS %}
              <span class="badge bg-secondary">Czeka na materiał</span>

            {% elif order.status == order.Status.COMPLETED %}
              <span class="badge bg-success">Zakończone</span>

            {% elif order.status == order.Status.CANCELLED %}
              <span class="badge bg-danger">Odwołane</span>

            {% else %}
              <span class="badge bg-light text-dark">Inny</span>
            {% endif %}
          </div>

          <div class="mb-2">
            <span class="text-muted">Termin realizacji:</span>
            {{ order.planned_date|date:"d.m.Y" }}
          </div>

          <div class="mb-2">
            <span class="text-muted">Przypisano do:</span>
            {% if order.assigned_to %}
              {{ order.assigned_to.get_full_name|default:order.assigned_to.username }}
            {% else %}
              <span class="text-muted">nieprzypisane</span>
            {% endif %}
          </div>

          {% if order.job %}
            <div class="mb-0">
              <span class="text-muted">Powiązana robota:</span>
              {{ order.job.name|default:order.job.id }}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-white">
          <h6 class="mb-0">Obiekt</h6>
        </div>
        <div class="card-body small">
          <div class="mb-1">
            <strong>{{ order.site.name }}</strong>
          </div>
          <div class="mb-1">
            {% if order.site.street %}
              {{ order.site.street }}
            {% endif %}
          </div>
          <div class="mb-1">
            {% if order.site.postal_code or order.site.city %}
              {{ order.site.postal_code }} {{ order.site.city }}
            {% endif %}
          </div>
          {% if order.site.manager %}
            <div class="mt-2">
              <span class="text-muted">Zarządca:</span>
              {{ order.site.manager.short_name|default:order.site.manager.full_name }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- PRAWA KOLUMNA: opis, systemy, protokół -->
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white">
          <h6 class="mb-0">Opis zgłoszenia</h6>
        </div>
        <div class="card-body small">
          {% if order.description %}
            <p class="mb-0" style="white-space: pre-wrap;">{{ order.description }}</p>
          {% else %}
            <p class="text-muted mb-0 small">Brak opisu.</p>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Systemy objęte zleceniem</h6>
        </div>
        <div class="card-body small">
          {% if order.systems.all %}
            <ul class="mb-0">
              {% for system in order.systems.all %}
                <li>
                  {{ system.get_system_type_display }} –
                  {% if system.manufacturer %}{{ system.manufacturer }}{% endif %}
                  {% if system.model %} {{ system.model }}{% endif %}
                  {% if system.in_contract %}
                    <span class="badge bg-success ms-2">w umowie</span>
                  {% endif %}
                </li>
              {% empty %}
                <li class="text-muted small">Brak przypisanych systemów.</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted small mb-0">Brak przypisanych systemów.</p>
          {% endif %}
        </div>
      </div>

      <!-- Protokół serwisowy – miejsce pod UX -->
      {% if order.work_type == order.WorkOrderType.SERVICE %}
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Protokół serwisowy</h6>
          </div>
          <div class="card-body small">
            {% if service_report %}
              <p class="mb-2">
                Protokół:
                {% if service_report.number %}
                  <strong>{{ service_report.number }}</strong>
                {% else %}
                  <span class="text-muted">bez numeru (szkic)</span>
                {% endif %}
                {% if service_report.report_date %}
                  z dnia {{ service_report.report_date|date:"d.m.Y" }}
                {% endif %}
              </p>
            {% else %}
              <p class="text-muted small mb-2">
                Brak powiązanego protokołu serwisowego.
              </p>
            {% endif %}

            <a href="{% url 'core:service_report_entry' order.pk %}"
              class="btn btn-sm btn-primary">
              Otwórz / utwórz protokół serwisowy
            </a>

            <p class="text-muted small mt-2 mb-0">
              Przycisk otwiera istniejący protokół lub tworzy nowy szkic (bez numeru).
              Numer PS zostanie nadany po zatwierdzeniu w biurze.
            </p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
