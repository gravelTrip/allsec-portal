{% load static %}
<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <title>{% block title %}ALLSEC Portal{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 z CDN (na start) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- Nasz styl (do rozbudowy) -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css">

</head>

<body class="bg-light">

  <!-- TOP BAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{% url 'core:dashboard' %}">
        ALLSEC Portal
      </a>

      {% if request.user.is_authenticated %}
      <div class="d-flex align-items-center ms-auto">
        <div class="dropdown me-2">
  <button class="btn btn-outline-light btn-sm border-0 shadow-none position-relative dropdown-toggle"

          type="button"
          id="woNotifBell"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          title="Powiadomienia zlece≈Ñ">
    üîî
    <span id="woNotifBadge"
          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark d-none">
      0
    </span>
  </button>

  <div class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="woNotifBell" style="min-width: 360px;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold small">Powiadomienia</div>
      <a href="{% url 'core:workorder_events' %}" class="small">Zobacz wszystkie</a>
    </div>

    <div id="woNotifDropdownList" class="list-group list-group-flush">
      <div class="text-muted small py-2">≈Åadowanie‚Ä¶</div>
    </div>

    <div class="mt-2 d-flex justify-content-between">
      <form method="post" action="{% url 'core:workorder_events_mark_all_read' %}" class="mb-0">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-secondary">Oznacz wszystkie</button>
      </form>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="woNotifRefreshBtn">Od≈õwie≈º</button>
    </div>
  </div>
</div>

        <span class="text-white-50 me-3 small">
          Zalogowano jako:
          <strong>
            {{ request.user.get_full_name|default:request.user.username }}
          </strong>
        </span>
        <form method="post" action="{% url 'logout' %}" class="mb-0">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-light btn-sm">
            Wyloguj
          </button>
        </form>
      </div>
      {% endif %}

    </div>
  </nav>

  <!-- MAIN LAYOUT -->
  <div class="container-fluid">
    <div class="row">
      <!-- LEWY SIDEBAR -->
<nav id="sidebar" class="d-md-block bg-dark text-white sidebar collapse">
        <div class="position-sticky pt-3">
          {% with url_name=request.resolver_match.url_name %}
          <ul class="nav flex-column">

            <li class="nav-item">
              <a class="nav-link sidebar-link {% if url_name == 'dashboard' %}active{% endif %}"
                href="{% url 'core:dashboard' %}">
                Dashboard
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link sidebar-link {% if url_name and 'workorder' in url_name %}active{% endif %}"
                href="{% url 'core:workorder_list' %}">
                Zlecenia
              </a>
            </li>

            <li class="nav-item">
              {# jak bƒôdziesz mia≈Ç listƒô protoko≈Ç√≥w, podmie≈Ñ href na odpowiedni URL #}
              <a class="nav-link sidebar-link {% if url_name and 'service_report' in url_name %}active{% endif %}"
                href="{% url 'core:service_report_list' %}">
                Serwisy
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link sidebar-link {% if url_name and 'maintenance_protocol' in url_name %}active{% endif %}"
                href="{% url 'core:maintenance_protocol_list' %}">
                Konserwacje
              </a>
            </li>

            <li class="nav-item">
              {# zak≈Çadam, ≈ºe widoki obiekt√≥w/system√≥w majƒÖ w nazwie site_ albo system_ #}
              <a class="nav-link sidebar-link {% if url_name and 'site_' in url_name or url_name and 'system_' in url_name %}active{% endif %}"
                href="{% url 'core:site_list' %}">
                Obiekty
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link sidebar-link {% if url_name and 'manager_' in url_name %}active{% endif %}"
                href="{% url 'core:manager_list' %}">
                ZarzƒÖdcy
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link sidebar-link {% if url_name and 'contact_' in url_name %}active{% endif %}"
                href="{% url 'core:contact_list' %}">
                Kontakty
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link sidebar-link {% if url_name and 'entity_' in url_name %}active{% endif %}"
                href="{% url 'core:entity_list' %}">
                Dane FV
              </a>
            </li>

          </ul>
          {% endwith %}
        </div>
      </nav>

      <!-- RIGHT CONTENT -->
      <main id="main-content" class="px-md-4 py-4">

        {% block content %}
        <!-- Tutaj wchodzƒÖ konkretne strony -->
        {% endblock %}
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="{% static 'js/dashboard.js' %}"></script>
  <script>
(function () {
  const badge = document.getElementById("woNotifBadge");
  const listEl = document.getElementById("woNotifDropdownList");
  const refreshBtn = document.getElementById("woNotifRefreshBtn");

  if (!badge) return;

  function setBadge(count) {
    if (count > 0) {
      badge.textContent = count > 99 ? "99+" : String(count);
      badge.classList.remove("d-none");
    } else {
      badge.classList.add("d-none");
    }
  }

  async function refreshCount() {
    const resp = await fetch("{% url 'core:api_workorder_events_unread_count' %}", {
      headers: { "Accept": "application/json" },
      credentials: "same-origin",
      cache: "no-store"
    });
    if (!resp.ok) return;
    const data = await resp.json();
    setBadge(Number(data.count || 0));
  }

  async function refreshLatest() {
    if (!listEl) return;

    const resp = await fetch("{% url 'core:api_workorder_events_unread_latest' %}", {
      headers: { "Accept": "application/json" },
      credentials: "same-origin",
      cache: "no-store"
    });
    if (!resp.ok) return;

    const data = await resp.json();
    const items = data.items || [];

    if (!items.length) {
      listEl.innerHTML = '<div class="text-muted small py-2">Brak nowych powiadomie≈Ñ.</div>';
      return;
    }

    listEl.innerHTML = items.map(it => `
      <a href="${it.url}" class="list-group-item list-group-item-action py-2">
        <div class="d-flex justify-content-between">
          <div class="fw-semibold small">${escapeHtml(it.title)}</div>
          <div class="text-muted small">${escapeHtml(it.created_at)}</div>
        </div>
        <div class="text-muted small">${escapeHtml(it.meta)}</div>
      </a>
    `).join("");
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, (c) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[c]));
  }

  async function refreshAll() {
    try {
      await refreshCount();
      await refreshLatest();
    } catch (_) {}
  }

  refreshAll();
  setInterval(refreshAll, 45000);

  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) refreshAll();
  });

  if (refreshBtn) refreshBtn.addEventListener("click", refreshAll);
})();
</script>


</body>

</html>